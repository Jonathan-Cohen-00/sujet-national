# Configuration GitLab CI/CD pour d√©ployer sur GitLab Pages
# Documentation: https://docs.gitlab.com/ee/user/project/pages/

# Image de base l√©g√®re
image: alpine:latest

# Variables d'environnement
variables:
  GIT_STRATEGY: clone
  GIT_DEPTH: 0

# √âtapes de la pipeline
stages:
  - test
  - deploy

# Job de validation (optionnel mais recommand√©)
validate:
  stage: test
  script:
    - echo "Validation des fichiers..."
    - test -f index.html || (echo "‚ùå index.html manquant" && exit 1)
    - test -f style.css || (echo "‚ùå style.css manquant" && exit 1)
    - test -f script.js || (echo "‚ùå script.js manquant" && exit 1)
    - echo "‚úÖ Tous les fichiers requis sont pr√©sents"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH =~ /^claude\/.*/'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Job de d√©ploiement GitLab Pages
# Important: Le job DOIT s'appeler "pages" pour GitLab Pages
pages:
  stage: deploy
  before_script:
    - echo "üöÄ D√©marrage du d√©ploiement GitLab Pages..."
    - echo "Branche: $CI_COMMIT_BRANCH"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
  script:
    # Cr√©er le r√©pertoire public (obligatoire pour GitLab Pages)
    - mkdir -p public

    # V√©rifier que les fichiers existent avant de les copier
    - |
      if [ ! -f "index.html" ]; then
        echo "‚ùå ERREUR: index.html n'existe pas!"
        exit 1
      fi

    # Copier tous les fichiers n√©cessaires vers public/
    - cp -v index.html public/
    - cp -v style.css public/
    - cp -v script.js public/

    # Copier les fichiers optionnels s'ils existent
    - cp -v README.md public/ 2>/dev/null || echo "‚ö†Ô∏è  README.md non trouv√© (optionnel)"
    - cp -v LICENSE public/ 2>/dev/null || echo "‚ö†Ô∏è  LICENSE non trouv√© (optionnel)"

    # Afficher le contenu du dossier public
    - echo "üìÅ Contenu du dossier public:"
    - ls -lah public/

    # V√©rifier la taille des fichiers
    - du -sh public/*

    - echo "‚úÖ D√©ploiement termin√© avec succ√®s!"

  # Artifacts: GitLab Pages a besoin du dossier "public"
  artifacts:
    paths:
      - public
    expire_in: 30 days

  # R√®gles de d√©clenchement
  rules:
    # D√©ployer sur la branche main
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    # D√©ployer sur toutes les branches claude/*
    - if: '$CI_COMMIT_BRANCH =~ /^claude\/.*/'
      when: always
    # Permettre le d√©clenchement manuel
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always

  # Environnement pour GitLab Pages
  environment:
    name: production
    url: https://$CI_PROJECT_ROOT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME
